# Design: Code Coverage Badge Implementation

## Overview

Add a visible code coverage badge to the README on the ng branch that automatically updates when code is pushed to the ng branch. Uses GitHub Pages to host the badge SVG and GitHub Actions to generate and update it.

## Current State

**Test Infrastructure:**
- ✅ Frontend package has 111 tests (vitest)
- ✅ Coverage configured in `vitest.config.ts` with `json-summary` reporter
- ✅ Test workflow runs on PRs (`.github/workflows/test.yml`)
- ✅ Test script: `npm run test:coverage` available

**Missing:**
- ❌ No coverage badge in README
- ❌ No automated coverage badge generation
- ❌ No GitHub Pages setup for badge hosting

## Solution Architecture

### Badge Hosting: GitHub Pages

**Why GitHub Pages?**
- No external dependencies (shields.io, coveralls.io, etc.)
- No API tokens or secrets required
- Simple SVG hosting from `gh-pages` branch
- Free for public repositories

**Structure:**
```
gh-pages branch
└── badges/
    └── coverage.svg  (auto-generated by action)
```

**Badge URL:**
```
https://<username>.github.io/<repo>/badges/coverage.svg
```

**Scope:** ng branch only - Badge will only be visible on ng branch README and will only update on ng branch pushes.

### Badge Generation: we-cli/coverage-badge-action

**Why this action?**
- ✅ No gist-id required (unlike other badge actions)
- ✅ No github-token required (uses built-in GITHUB_TOKEN)
- ✅ No entire upload to gh-pages (just patches badge file)
- ✅ Supports vitest/jest/c8/nyc coverage formats
- ✅ Simple setup with minimal configuration

**How it works:**
1. Action reads `coverage/coverage-summary.json` (generated by vitest)
2. Generates SVG badge with coverage percentage
3. Commits only the badge file to `gh-pages` branch
4. GitHub Pages serves the updated badge

### Workflow Integration

**Current Workflow (.github/workflows/test.yml):**
```yaml
- name: Run frontend tests
  working-directory: ./packages/frontend
  run: npm test  # No coverage
```

**Updated Workflow:**
```yaml
- name: Run frontend tests with coverage
  working-directory: ./packages/frontend
  run: npm run test:coverage  # Generates coverage-summary.json

- name: Update Coverage Badge
  if: github.ref == 'refs/heads/ng'
  uses: we-cli/coverage-badge-action@main
```

**Branch Condition Explained:**
- Only runs on pushes to `ng` branch (not main, not PRs)
- Prevents badge update on every PR (would be noisy)
- Keeps badge scope limited to ng branch for testing
- Uses GitHub Actions syntax to check current branch

## Design Decisions

### 1. Frontend Package Only (Not Backend)

**Decision:** Generate badge for frontend package coverage only.

**Rationale:**
- Frontend has comprehensive test suite (111 tests)
- Backend testing is less mature
- Single badge is simpler to understand
- Can add backend badge later if needed

**Alternative Considered:** Combined coverage badge
- **Rejected:** Would require custom aggregation script, adds complexity

### 2. Badge Placement in README

**Decision:** Place badge at the top of README after logo/title section, only on ng branch.

**Rationale:**
- High visibility for visitors to ng branch
- Standard practice in OSS projects
- Near other badges if they exist (build status, version, etc.)
- ng branch is the active development branch

**Example Placement:**
```markdown
# Quiqr Desktop NG

[![cov](https://user.github.io/repo/badges/coverage.svg)](https://github.com/user/repo/actions)

Quiqr Desktop NG is a major upgrade...
```

**Note:** Badge will only appear in ng branch README, not in main branch.

### 3. Run Coverage on NG Pushes Only

**Decision:** Only run coverage badge update on ng branch pushes, not main or PRs.

**Rationale:**
- ng branch is the Next Generation branch being actively developed
- Allows testing badge setup before potentially adding to main later
- Main branch remains unchanged (will eventually be renamed to legacy)
- PRs already run tests (no coverage needed for CI)
- Badge should reflect ng branch coverage only
- Reduces GitHub Actions minutes usage
- Prevents badge "thrashing" on every PR

**Implementation:**
```yaml
if: github.ref == 'refs/heads/ng'
```

**Note:** The action version tag `@main` refers to the action's repository main branch, not this project's main branch.

### 4. Use we-cli/coverage-badge-action

**Decision:** Use `we-cli/coverage-badge-action@main` instead of alternatives.

**Alternatives Considered:**

| Action | Pros | Cons | Decision |
|--------|------|------|----------|
| **we-cli/coverage-badge-action** | No tokens, simple setup, minimal config | Fewer stars (58) | ✅ **Selected** |
| codecov/codecov-action | Popular, feature-rich | Requires account, external service | ❌ Too complex |
| coverallsapp/github-action | Established service | Requires account, token | ❌ External dependency |
| shields.io endpoint | Flexible | Requires token or public gist | ❌ More setup |

**Rationale for we-cli:**
- Meets all requirements with minimal setup
- No external accounts or tokens
- Perfect for straightforward use case
- Similar to action suggested by user

### 5. GitHub Pages Setup Required

**Decision:** Require manual gh-pages branch creation as prerequisite.

**Rationale:**
- One-time setup task
- Prevents workflow from failing on first run
- Follows action's documented prerequisites
- Clear error message if not set up

**Setup Steps:**
```bash
git switch --orphan gh-pages
git commit --allow-empty -m "Initial commit"
git push -u origin gh-pages
```

Then: Enable Pages in Settings → Pages → Source: gh-pages / (root)

## Implementation Strategy

### Phase 1: Prerequisites
1. Verify/create gh-pages branch
2. Enable GitHub Pages
3. Set workflow permissions to "Read and write"

### Phase 2: Workflow Update
1. Change test command to `npm run test:coverage`
2. Add coverage badge action step
3. Add branch condition to only run on ng branch

### Phase 3: Documentation
1. Add badge to README
2. Update ci-automation spec

## Risk Assessment

**Low Risk:**
- Purely additive change (no breaking changes)
- Only affects ng branch pushes (main branch unaffected)
- Test workflow continues to work on PRs

**Potential Issues:**

1. **gh-pages branch doesn't exist**
   - Mitigation: Document prerequisite, provide setup commands
   - Impact: Workflow will fail until set up

2. **Workflow permissions insufficient**
   - Mitigation: Document required permission setting
   - Impact: Badge won't update until permissions fixed

3. **Badge doesn't display**
   - Mitigation: Verify GitHub Pages is enabled and serving content
   - Impact: Badge link will be broken until Pages configured

## Validation Plan

**Manual Testing:**
1. Create test branch with changes
2. Open PR to ng to verify tests still run (no badge update)
3. Merge to ng
4. Verify workflow runs coverage and updates badge
5. Check gh-pages branch for `badges/coverage.svg`
6. Verify badge displays in ng branch README only
7. Verify badge does NOT appear in main branch README

**Automated Validation:**
- Existing test suite continues to pass (111 tests)
- OpenSpec validation for spec deltas

## Alternative Approaches Considered

### Alternative 1: Use External Service (Codecov/Coveralls)
**Rejected because:**
- Requires external account and token management
- Adds dependency on third-party service
- More complex setup
- Not aligned with user's suggestion

### Alternative 2: Generate Badge Locally in Workflow
**Rejected because:**
- Would require custom script to generate SVG
- More maintenance burden
- Reinventing existing solution
- we-cli action already does this well

### Alternative 3: Use shields.io with Gist
**Rejected because:**
- Requires creating and maintaining a GitHub Gist
- Requires token for gist updates
- More moving parts than GitHub Pages approach
- Not as clean as direct GitHub Pages hosting

## Future Enhancements (Out of Scope)

- Add backend coverage badge
- Add combined coverage badge (frontend + backend)
- Add coverage trend graph
- Add coverage requirements enforcement (minimum threshold)
- Add coverage reporting comments on PRs
